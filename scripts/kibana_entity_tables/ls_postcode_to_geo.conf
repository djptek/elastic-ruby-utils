input {
  file {
    path => "/home/ubuntu/Developer1/datasets/test_result_2016.txt"
    sincedb_path => "/dev/null"
    start_position => "beginning"
  }
}

filter {
 
  dissect {
    mapping => {
      "message" => '%{test_id}|%{vehicle_id}|%{test_date}|%{test_class_id}|%{test_type}|%{test_result}|%{test_mileage}|%{postcode_area}|%{make}|%{model}|%{colour}|%{fuel_type}|%{cylinder_capacity}|%{first_use_date}'
    }
  }

  ruby {
    init => "@h={'B'=>'52.475924,-1.905392','S'=>'53.38155,-1.4635271','NG'=>'52.955008,-1.1410455','BS'=>'51.45843,-2.5741791','PE'=>'52.572609,-0.24557785','LE'=>'52.632283,-1.1248594','NE'=>'54.967722,-1.6157868','G'=>'55.858354,-4.2427968','PO'=>'50.799292,-1.0883697','RG'=>'51.457494,-0.96924386','NR'=>'52.626652,1.3092653','M'=>'53.483848,-2.2452159','CV'=>'52.407719,-1.5119578','GU'=>'51.245291,-0.58231792','TN'=>'51.133203,0.26174055','DE'=>'52.91504,-1.4661393','BN'=>'50.826334,-0.1408184','DN'=>'53.523055,-1.134819','GL'=>'51.865133,-2.2436989','SA'=>'51.647959,-3.9240331','EH'=>'55.948969,-3.1927988','NN'=>'52.24527,-0.89824517','IP'=>'52.05285,1.1466997','CM'=>'51.737213,0.47599066','EX'=>'50.722777,-3.5319511','ST'=>'53.02448,-2.1766584','BH'=>'50.7279,-1.8635802','CH'=>'53.190292,-2.8882928','PL'=>'50.371067,-4.138628','OX'=>'51.750231,-1.2673668','ME'=>'51.386148,0.50743955','LS'=>'53.796305,-1.5641256','WA'=>'53.386795,-2.599263','RH'=>'51.240567,-0.1646819','SK'=>'53.407561,-2.1615617','YO'=>'53.96043,-1.0923361','L'=>'53.397164,-2.9803208','MK'=>'52.010918,-0.7258133','HP'=>'51.7484,-0.46988523','TS'=>'54.575852,-1.2449419','PR'=>'53.750281,-2.7287628','SE'=>'51.498409,-0.10165523','SN'=>'51.565377,-1.7832322','SS'=>'51.543523,0.71237046','E'=>'51.512497,-0.05209791','WF'=>'53.679401,-1.5007335','KT'=>'51.408596,-0.30433927','BD'=>'53.796262,-1.7507642','RM'=>'51.5776,0.17826093','CT'=>'51.284728,1.0943387','BB'=>'53.749097,-2.4599383','CO'=>'51.898868,0.89662288','N'=>'51.539425,-0.11793111','WS'=>'52.586086,-1.9814187','NW'=>'51.536729,-0.13944085','TW'=>'51.450065,-0.33227783','SG'=>'51.896109,-0.20285494','HU'=>'53.744038,-0.33314355','CB'=>'52.209345,0.14823086','DA'=>'51.4445,0.20975447','BL'=>'53.579295,-2.4326277','TA'=>'51.023451,-3.1097032','SL'=>'51.508271,-0.58461853','SY'=>'52.713154,-2.7491161','WV'=>'52.588315,-2.1147777','TR'=>'50.255282,-5.0461064','KY'=>'56.098856,-3.166243','OL'=>'53.541494,-2.0998263','HA'=>'51.581021,-0.33679754','LN'=>'53.245724,-0.55879653','CW'=>'53.097956,-2.4331421','LU'=>'51.879977,-0.42292639','UB'=>'51.5075,-0.37848347','CA'=>'54.890918,-2.9438462','WR'=>'52.19668,-2.2169369','DL'=>'54.522095,-1.5507508','TQ'=>'50.463029,-3.5256262','KA'=>'55.603242,-4.5102658','LA'=>'54.048151,-2.8038266','EN'=>'51.651933,-0.077090768','ML'=>'55.793568,-3.9949326','SP'=>'51.070565,-1.7957965','PA'=>'55.846551,-4.4221082','DH'=>'54.786659,-1.5300977','FK'=>'56.001996,-3.7847771','FY'=>'53.818782,-3.0516572','WN'=>'53.546967,-2.6350889','DD'=>'56.462234,-2.9735422','AL'=>'51.747828,-0.30186478','IV'=>'57.481332,-4.2239504'}"
    code => "
l = (@h.key?(event.get('postcode_area')) && @h[event.get('postcode_area')] or 'drop');
event.set('location',l)
"
  } 

  if [location] == "drop" { drop { } }

  mutate {
    remove_field => [ "@timestamp", "host", "message", "@version", "test_id", "test_date", "test_class_id", "test_type", "test_result", "test_mileage", "model", "colour", "fuel_type", "cylinder_capacity", "first_use_date", "path" ] 
  }
  mutate {
    convert => { 
      "vehicle_id" => "integer" 
    }
  }
  mutate {
    rename => { "make" => "manufacturer" }
  }
}

output {
  elasticsearch { index => 'manufacturer_vs_postcode' }
} 

